---
theme: default
class: text-center
highlighter: shiki
transition: slide-left
---

# Урок 6

## Apscheduler - Планировщик задач

---
layout: center
---

- ### Задача - кусок кода, который будет выполняться по расписанию.
- ### Часто это функция или набор функций. 
- ### Пример задачи - отправлять отчет бухгалтеру два раза в месяц в определенные числа или дни недели, скажем в *первую и последнюю пятницу месяца*. 
- ### Еще пример - по e-mail поздравлять сотрудников с новым годом или с днем рождения(определенные числа).

---
layout: center
---

- ### То, как будут выполняться эти задачи, например по e-mail или через Telegram - это уже другой вопрос.
- ### Но самое главное, как сделать расписание для этих действий.

---
layout: center
---

## Apscheduler помогает:
- ### задать расписание выполнения задач(каких-либо функций)
- ### передать в эти функции какие-либо аргументы

---
layout: cover
---

## Для чего использовать в Telegram?
- ### делать рассылку
  - #### ***в TG бот может отправлять сообщения только тем пользователям, которые уже с ним контактировали***
- ### отправлять сообщения после выполнения долгой задачи
- ### отправлять сообщения по расписанию

---
layout: center
---

## Документация на [apscheduler](https://apscheduler.readthedocs.io/en/latest/)
### Установка: `pip install apscheduler`

---
layout: center
---

## Терминология:
- ### **Задача** - кусок кода, который будет выполняться по расписанию(который выполняет какую-либо задачу)

---
layout: cover
---

## Терминология:
- ### **Режим** - способ задать расписание. Есть 3 режима:
    - ### `date` - задать расписание по дате
    - ### `interval` - задать расписание по интервалу
    - ### `cron` - задать расписание по крону

---
layout: cover
---

## Терминология:
- ### **Хранилище** - то, где будут храниться данные о задачах. Например база данных или просто оперативная память.
    - #### *По умолчанию, задачи хранятся в памяти, это значит, что при перезапуске программы, задачи будут теряться*

---
layout: cover
---

## Терминология:
- ### **Класс планировщика**:
    - #### `BlockingScheduler` - можно использовать, когда задачи выполняются вместе с кодом, и поэтому могут блокировать выполнение остального кода
    - #### `BackgroundScheduler` - с этим классом задачи будут выполняться в отдельном потоке. Это может быть полезно при больших задачах. Задачи выполняются в фоне. Его следует использовать, когда не используется один из нижеперечисленных фреймворков
    - #### `AsyncIOScheduler` - это планировщик задач, который поддерживает асинхронные задачи. Для использования в приложениях, где есть asyncio модуль
    - #### `GeventScheduler` - это планировщик задач, который поддерживает задачи в Gevent
    - #### `TornadoScheduler` - это планировщик задач, который поддерживает задачи в Tornado
    - #### `TwistedScheduler` - это планировщик задач, который поддерживает задачи в Twisted
    - #### `QtScheduler` - это планировщик задач, который поддерживает задачи в Qt

---
layout: cover
---

## Запуск планировщика:
- ### `start()` - запуск планировщика, *непосредственно перед запуском бота*
- ### `stop()` - остановка планировщика

---
layout: cover
---

## Добавление задач:
- ### `scheduler.add_job()` - добавление задачи
- ### `scheduler.remove_job()` - удаление задачи

---
layout: cover
highlighter: shiki
---

## Режимы:
### Interval
```python {all|10|1-8|3|2,10|4-6|7,10}{lines:true}
scheduler.add_job(
    send_my_message,
    'interval',
    hours=1,
    minutes=5,
    seconds=10,
    kwargs={'val': 'hello'},
)

async def send_my_message(val: str):
    print(val)
```

---
layout: cover
---

## Режимы:
### Interval
### Аргументы для задания интервала:
- `weeks`: количество недель
- `days`: количество дней
- `hours`: количество часов
- `minutes`: количество минут
- `seconds`: количество секунд
- `start_date`: дата начала интервала
- `end_date`: дата окончания интервала

---
layout: cover
---

## Режимы:
### Date
```python {all|8|1-6|3|2,8|4|5,8}{lines:true}
scheduler.add_job(
    send_my_message,
    'date',
    run_date=datetime(2024, 2, 20, 17, 10, 5),
    kwargs={'val': 'hello'},
)

async def send_my_message(val: str):
    print(val)

```

---
layout: cover
---

## Режимы:
### Date
### Аргументы для задания даты:
- `run_date`: дата запуска, можно задать через datetime или timedelta

---
layout: cover
---

## Режимы:
### Cron
```python {all|11|1-9|3|2,11|4-7|8,11}{lines:true}
scheduler.add_job(
    send_my_message,
    'cron',
    day_of_week='mon',
    hour=17,
    minute=10,
    second=5,
    kwargs={'val': 'hello'},
)

async def send_my_message(val: str):
    print(val)
```

---
layout: cover
---

## Режимы:
### Cron
### Аргументы для задания cron:
- `year`: год(например: 2024, 2025)
- `month`: месяц(например: 1, 12) [*от 1 до 12*]
- `day`: день(например: 1, 12, 21) [*от 1 до 31*]
- `week`: неделя(например: 1, 2, 3;) [*от 1 до 53*]
- `day_of_week`: день недели(например: 'mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun')
- `hour`: час(*от 0 до 23*)
- `minute`: минута(*от 0 до 59*)
- `second`: секунда(*от 0 до 59*)
- `start_date`: дата начала интервала
- `end_date`: дата окончания интервала

---
layout: end
---

### Спасибо за внимание
